name: Build & Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release-macos:
    name: Build, Sign, Notarize & Package (macOS)
    strategy:
      matrix:
        include:
          - arch: arm64
            os: macos-14
            triplet: arm64-osx
          - arch: x86_64
            os: macos-13
            triplet: x64-osx
    runs-on: ${{ matrix.os }}
    
    env:
      APP_NAME: CognitivePipelines
      QT_VERSION: "6.6.3"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Qt ${{ env.QT_VERSION }}
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          modules: 'qtpdf qtwebengine qtwebchannel qtpositioning qtserialport'
          cache: true

      - name: Install build dependencies
        run: |
          brew update
          if [ "${{ matrix.arch }}" == "x86_64" ]; then
            brew install python --overwrite
            brew install autoconf automake libtool pkg-config gettext autoconf-archive ninja mono
          else
            brew install autoconf automake libtool pkg-config gettext autoconf-archive ninja mono python
          fi
          
          BREW_PREFIX=$(brew --prefix)
          echo "${BREW_PREFIX}/opt/gettext/bin" >> $GITHUB_PATH
          echo "ACLOCAL_PATH=${BREW_PREFIX}/share/aclocal:${BREW_PREFIX}/opt/gettext/share/aclocal" >> $GITHUB_ENV
          echo "${BREW_PREFIX}/bin" >> $GITHUB_PATH

      - name: Bootstrap vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: a2efad2ec955878d30db81d730490e931b84850f
          runVcpkgInstall: false

      - name: Run vcpkg install
        shell: bash
        run: |
          unset VCPKG_FORCE_SYSTEM_BINARIES
          "${VCPKG_ROOT}/vcpkg" install --triplet=${{ matrix.triplet }}

      - name: "Step 1: Keychain & Certificate Import"
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/build.keychain
          KEYCHAIN_PWD=$(openssl rand -base64 12)
          security create-keychain -p "$KEYCHAIN_PWD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PWD" "$KEYCHAIN_PATH"
          
          echo "$MACOS_CERTIFICATE" | base64 --decode > "$RUNNER_TEMP/certificate.p12"
          security import "$RUNNER_TEMP/certificate.p12" -k "$KEYCHAIN_PATH" -P "$MACOS_CERTIFICATE_PWD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PWD" "$KEYCHAIN_PATH"
          
          # Add keychain to search list
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | xargs)

      - name: "Step 2: Dynamic Identity Resolution"
        run: |
          IDENTITY_NAME=$(security find-identity -v -p codesigning | grep "Developer ID Application" | head -n 1 | sed -E 's/.*"(.*)".*/\1/')
          echo "MACOS_CERT_ID=$IDENTITY_NAME" >> $GITHUB_ENV
          echo "Found identity: $IDENTITY_NAME"

      - name: "Step 3: Build & Sign"
        shell: bash
        run: |
          CMAKE_FLAGS="-S . -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=${{ env.VCPKG_ROOT }}/scripts/buildsystems/vcpkg.cmake \
            -DCMAKE_PREFIX_PATH=${{ env.Qt6_DIR }} \
            -DENABLE_TESTING=OFF \
            -DRELEASE_BUILD=ON \
            -DMACOS_SIGNING_IDENTITY=\"${{ env.MACOS_CERT_ID }}\" \
            -DCMAKE_OSX_ARCHITECTURES='${{ matrix.arch }}' \
            -DVCPKG_TARGET_TRIPLET=${{ matrix.triplet }}"
          
          cmake $CMAKE_FLAGS
          cmake --build build --config Release --target CognitivePipelines -j 2
          
          # Run macos_deploy_all to finish deployment and signing
          cmake --build build --target macos_deploy_all --config Release

      - name: "Step 4: Notarization"
        env:
          APPLE_ID: ${{ secrets.MACOS_NOTARIZATION_APPLE_ID }}
          TEAM_ID: ${{ secrets.MACOS_NOTARIZATION_TEAM_ID }}
          PWD: ${{ secrets.MACOS_NOTARIZATION_PWD }}
        run: |
          ditto -c -k --keepParent build/bin/CognitivePipelines.app app.zip
          xcrun notarytool submit app.zip --apple-id "$APPLE_ID" --team-id "$TEAM_ID" --password "$PWD" --wait

      - name: "Step 5: Staple & Package"
        run: |
          xcrun stapler staple build/bin/CognitivePipelines.app
          hdiutil create -volname "CognitivePipelines" -srcfolder build/bin/CognitivePipelines.app -ov -format UDZO CognitivePipelines-${{ matrix.arch }}.dmg

      - name: "Step 6: Release"
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: CognitivePipelines-${{ matrix.arch }}.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
